<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sertifikat Massal - A4 Portrait</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .canvas-container { border: 1px solid #ccc; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); margin: 0 auto; }
        .hidden { display: none; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <nav class="bg-slate-800 p-4 text-white flex justify-between items-center shadow-lg">
        <h1 class="text-xl font-bold tracking-tight">Sertifikat Pro <span class="text-blue-400 font-light">| Portrait Mode</span></h1>
        <div class="flex gap-4">
            <button onclick="logout()" class="text-sm bg-red-500 px-3 py-1 rounded hover:bg-red-600 transition">Logout</button>
        </div>
    </nav>

    <div class="p-6 max-w-7xl mx-auto">
        <div class="flex flex-col lg:flex-row gap-8">
            
            <div class="w-full lg:w-1/3 space-y-6">
                
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <span class="bg-blue-100 text-blue-600 w-6 h-6 flex items-center justify-center rounded-full text-xs">1</span>
                        Pengaturan Desain (A4 Portrait)
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Background Portrait</label>
                            <input type="file" id="bgInput" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>

                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="addText('Nama Peserta', 35, 'obj_name')" class="bg-indigo-500 text-white p-2 rounded text-xs font-medium hover:bg-indigo-600 transition">Add Nama (Massal)</button>
                            <button onclick="addText('No: 000/SRT/2026', 18, 'obj_number')" class="bg-indigo-500 text-white p-2 rounded text-xs font-medium hover:bg-indigo-600 transition">Add Nomor (Massal)</button>
                        </div>
                        
                        <div class="pt-2">
                            <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">Stempel / TTD (PNG)</label>
                            <input type="file" id="assetInput" accept="image/png" class="w-full text-sm border p-2 rounded-lg">
                        </div>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <span class="bg-green-100 text-green-600 w-6 h-6 flex items-center justify-center rounded-full text-xs">2</span>
                        Data Penerima
                    </h3>
                    
                    <textarea id="bulkDataInput" class="w-full h-40 border-gray-200 border-2 p-3 text-sm font-mono rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Budi Santoso, 001/A/2026&#10;Siti Aminah, 002/A/2026"></textarea>
                    
                    <div class="flex justify-between mt-2">
                        <button onclick="downloadTemplateExcel()" class="text-xs text-blue-600 hover:underline">Ekspor ke Excel</button>
                        <button onclick="deleteObject()" class="text-xs text-red-500 hover:underline">Hapus Elemen Terpilih</button>
                    </div>

                    <div class="mt-6 space-y-3">
                        <div id="processingIndicator" class="hidden flex items-center justify-center gap-3 bg-blue-50 p-3 rounded-lg border border-blue-100">
                            <div class="loader"></div>
                            <span class="text-xs font-bold text-blue-700">Membuat PDF...</span>
                        </div>

                        <button onclick="generateBulkPDF()" class="w-full bg-slate-800 hover:bg-black text-white font-bold py-3 rounded-xl shadow-lg transition flex items-center justify-center gap-2">
                            Download PDF Massal (Portrait)
                        </button>
                    </div>
                </div>
            </div>

            <div class="w-full lg:w-2/3 flex flex-col items-center">
                <span class="text-xs font-bold text-gray-400 mb-2 uppercase tracking-widest text-center">Preview Kanvas (794 x 1123 px)</span>
                <div class="bg-white p-4 shadow-2xl rounded-sm border border-gray-300">
                    <canvas id="c" width="794" height="1123"></canvas>
                </div>
            </div>

        </div>
    </div>

    <script>
        window.jsPDF = window.jspdf.jsPDF;
        let canvas;

        // Inisialisasi Canvas Portrait
        function initCanvas() {
            canvas = new fabric.Canvas('c');
            canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));
        }

        // 1. Logika Background Portrait
        document.getElementById('bgInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function (event) {
                const imgObj = new Image();
                imgObj.src = event.target.result;
                imgObj.onload = function () {
                    const imgInstance = new fabric.Image(imgObj);
                    // Sesuaikan background dengan ukuran kanvas portrait
                    canvas.setBackgroundImage(imgInstance, canvas.renderAll.bind(canvas), {
                        scaleX: canvas.width / imgInstance.width,
                        scaleY: canvas.height / imgInstance.height
                    });
                }
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        // 2. Tambah Teks & Aset
        function addText(placeholder, fontSize, idName) {
            const text = new fabric.IText(placeholder, {
                left: canvas.width / 2,
                top: 400,
                originX: 'center',
                fontFamily: 'Times New Roman',
                fontSize: fontSize,
                fontWeight: 'bold',
                fill: '#000000',
                id: idName
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        document.getElementById('assetInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function (event) {
                fabric.Image.fromURL(event.target.result, function(img) {
                    img.scaleToWidth(150);
                    canvas.add(img);
                });
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        function deleteObject() {
            const active = canvas.getActiveObject();
            if (active) canvas.remove(active);
        }

        // 3. GENERATE PDF MASSAL (PORTRAIT)
        async function generateBulkPDF() {
            const rawData = document.getElementById('bulkDataInput').value.trim();
            const data = rawData.split('\n').map(line => {
                const parts = line.split(',');
                return parts.length >= 2 ? { name: parts[0].trim(), num: parts[1].trim() } : null;
            }).filter(i => i);

            if(data.length === 0) return alert('Masukkan data Nama, Nomor!');

            const nameObj = canvas.getObjects().find(o => o.id === 'obj_name');
            const numObj = canvas.getObjects().find(o => o.id === 'obj_number');

            document.getElementById('processingIndicator').classList.remove('hidden');

            // Set PDF ke Portrait ('p')
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const pdfW = pdf.internal.pageSize.getWidth();
            const pdfH = pdf.internal.pageSize.getHeight();

            for (let i = 0; i < data.length; i++) {
                if(nameObj) nameObj.set({ text: data[i].name });
                if(numObj) numObj.set({ text: data[i].num });
                canvas.renderAll();

                const imgData = canvas.toDataURL({ format: 'jpeg', quality: 0.9 });
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfW, pdfH);
                
                if (i < data.length - 1) pdf.addPage();
            }

            pdf.save('Sertifikat_Portrait_Massal.pdf');
            document.getElementById('processingIndicator').classList.add('hidden');
        }

        // 4. EXCEL & LAINNYA
        function downloadTemplateExcel() {
            const rawData = document.getElementById('bulkDataInput').value.trim();
            const rows = rawData.split('\n').map(l => l.split(','));
            const ws = XLSX.utils.aoa_to_sheet([["Nama", "Nomor Sertifikat"], ...rows]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, "Data_Penerima.xlsx");
        }

        function logout() { location.reload(); }

        // Start
        initCanvas();
    </script>
</body>
</html>
