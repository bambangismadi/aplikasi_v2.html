<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Sertifikat Massal & Kwitansi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        .canvas-container { border: 1px solid #ccc; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin: 0 auto; }
        .hidden { display: none; }
        /* Loader Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="loginPage" class="flex items-center justify-center h-screen bg-gray-800">
        <div class="bg-white p-8 rounded shadow-lg w-96">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Sertifikat Pro</h2>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                <input type="text" id="username" class="shadow appearance-none border rounded w-full py-2 px-3 focus:outline-none" placeholder="admin">
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 focus:outline-none" placeholder="admin">
            </div>
            <button onclick="handleLogin()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full transition">Masuk</button>
        </div>
    </div>

    <div id="mainDashboard" class="hidden min-h-screen pb-10">
        <nav class="bg-blue-700 p-4 text-white flex justify-between items-center shadow-md">
            <h1 class="text-xl font-bold">Generator Massal</h1>
            <div class="flex gap-2">
                <button onclick="showPage('sertifikat')" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm">Sertifikat</button>
                <button onclick="showPage('kwitansi')" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm">Kwitansi</button>
                <button onclick="logout()" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded text-sm">Keluar</button>
            </div>
        </nav>

        <div id="pageSertifikat" class="p-4 max-w-7xl mx-auto">
            <div class="flex flex-col lg:flex-row gap-4">
                
                <div class="w-full lg:w-1/3 space-y-4">
                    
                    <div class="bg-white p-4 rounded shadow">
                        <h3 class="font-bold text-gray-800 border-b pb-2 mb-2">1. Desain & Layout</h3>
                        
                        <label class="block text-xs font-bold text-gray-600 mt-2">Upload Background (A4)</label>
                        <input type="file" id="bgInput" accept="image/*" class="w-full text-xs mb-2 border p-1">
                        
                        <label class="block text-xs font-bold text-gray-600 mt-2">Upload TTD / Stempel</label>
                        <input type="file" id="assetInput" accept="image/png" class="w-full text-xs mb-2 border p-1">

                        <div class="grid grid-cols-2 gap-2 mt-3">
                            <button onclick="addText('Nama Peserta', 30, 'obj_name')" class="bg-indigo-600 text-white py-1 px-2 rounded text-xs hover:bg-indigo-700">Add Nama (Massal)</button>
                            <button onclick="addText('No. Register', 18, 'obj_number')" class="bg-indigo-600 text-white py-1 px-2 rounded text-xs hover:bg-indigo-700">Add Nomor (Massal)</button>
                            <button onclick="addText('Teks Bebas', 20, null)" class="bg-gray-500 text-white py-1 px-2 rounded text-xs hover:bg-gray-600">Add Teks Biasa</button>
                            <button onclick="deleteObject()" class="bg-red-500 text-white py-1 px-2 rounded text-xs hover:bg-red-600">Hapus Item</button>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-2 italic">*Klik item di kanvas untuk edit/geser.</p>
                    </div>

                    <div class="bg-white p-4 rounded shadow">
                        <div class="flex justify-between items-center border-b pb-2 mb-2">
                            <h3 class="font-bold text-gray-800">2. Data Massal</h3>
                            <button onclick="downloadTemplateExcel()" class="text-xs text-blue-600 underline">Simpan Data ke Excel</button>
                        </div>
                        
                        <label class="block text-xs text-gray-600 mb-1">Masukkan Data (Format: Nama, Nomor)</label>
                        <textarea id="bulkDataInput" class="w-full h-32 border p-2 text-sm font-mono rounded" placeholder="Budi Santoso, 001&#10;Siti Aminah, 002&#10;Joko Widodo, 003"></textarea>
                        
                        <div class="mt-3 space-y-2">
                            <div id="processingIndicator" class="hidden flex items-center justify-center gap-2 bg-yellow-100 p-2 rounded">
                                <div class="loader"></div>
                                <span class="text-xs font-bold text-yellow-700">Sedang memproses PDF...</span>
                            </div>

                            <button onclick="generateBulkPDF()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded shadow flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                Generate & Download PDF
                            </button>
                            <button onclick="downloadSingleImage()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs py-2 rounded">Download Preview Saat Ini (PNG)</button>
                        </div>
                    </div>
                </div>

                <div class="w-full lg:w-2/3 bg-gray-300 p-4 rounded flex justify-center overflow-auto shadow-inner">
                    <canvas id="c" width="1123" height="794"></canvas>
                </div>
            </div>
        </div>

        <div id="pageKwitansi" class="hidden p-6 max-w-6xl mx-auto">
             <div class="flex flex-col lg:flex-row gap-6">
                <div class="w-full lg:w-1/3 bg-white p-6 rounded shadow">
                    <h2 class="text-xl font-bold mb-4">Input Kwitansi</h2>
                    <form id="kwitansiForm" class="space-y-3">
                        <input type="text" id="k_no" class="border w-full p-2 rounded text-sm" placeholder="No. Kwitansi (KW-001)">
                        <input type="text" id="k_from" class="border w-full p-2 rounded text-sm" placeholder="Telah Terima Dari">
                        <textarea id="k_text_amount" class="border w-full p-2 rounded text-sm" placeholder="Terbilang (Satu Juta Rupiah)"></textarea>
                        <textarea id="k_purpose" class="border w-full p-2 rounded text-sm" placeholder="Untuk Pembayaran"></textarea>
                        <input type="number" id="k_amount" class="border w-full p-2 rounded text-sm" placeholder="Nominal Angka (1000000)">
                        <input type="text" id="k_date" class="border w-full p-2 rounded text-sm" placeholder="Tempat & Tanggal">
                        <input type="text" id="k_receiver" class="border w-full p-2 rounded text-sm" placeholder="Nama Penerima">
                        <button type="button" onclick="generateKwitansi()" class="w-full bg-blue-600 text-white py-2 rounded font-bold">Update Preview</button>
                    </form>
                </div>
                <div class="w-full lg:w-2/3 bg-white p-8 rounded shadow border-2 border-dashed border-gray-300" id="kwitansiPreview">
                    <div class="border-4 border-gray-800 p-8 relative bg-yellow-50 min-h-[400px]">
                        <div class="flex justify-between items-center mb-8 border-b-2 border-gray-800 pb-2">
                            <h1 class="text-3xl font-bold uppercase tracking-widest text-gray-800">Kwitansi</h1>
                            <p>No: <span id="p_no" class="font-mono font-bold text-red-600">...</span></p>
                        </div>
                        <div class="space-y-4 text-lg">
                            <div class="flex"><span class="w-40 font-semibold">Diterima dari</span>: <span id="p_from" class="border-b border-dotted border-gray-600 flex-1 ml-2">...</span></div>
                            <div class="flex"><span class="w-40 font-semibold">Uang Sejumlah</span>: <div class="bg-gray-200 p-1 px-3 italic font-serif flex-1 rounded ml-2" id="p_text_amount">...</div></div>
                            <div class="flex"><span class="w-40 font-semibold">Pembayaran</span>: <span id="p_purpose" class="border-b border-dotted border-gray-600 flex-1 ml-2">...</span></div>
                        </div>
                        <div class="mt-10 flex justify-between items-end">
                            <div class="bg-gray-800 text-white text-2xl font-bold py-2 px-6 rounded shadow-lg -rotate-2">Rp <span id="p_amount">0,-</span></div>
                            <div class="text-center w-64">
                                <p id="p_date" class="mb-8">Jakarta, ...</p>
                                <p id="p_receiver" class="font-bold border-b border-gray-800 pb-1">...</p>
                            </div>
                        </div>
                    </div>
                    <button onclick="printKwitansi()" class="mt-4 bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-700">Cetak</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SETUP & LOGIN ---
        window.jsPDF = window.jspdf.jsPDF; // Init jsPDF Global

        function handleLogin() {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(u === 'admin' && p === 'admin') {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainDashboard').classList.remove('hidden');
                initCanvas();
            } else { alert('Login Gagal! (admin/admin)'); }
        }
        function logout() { location.reload(); }
        function showPage(page) {
            document.getElementById('pageSertifikat').classList.add('hidden');
            document.getElementById('pageKwitansi').classList.add('hidden');
            if(page === 'sertifikat') document.getElementById('pageSertifikat').classList.remove('hidden');
            if(page === 'kwitansi') document.getElementById('pageKwitansi').classList.remove('hidden');
        }

        // --- 2. CANVAS LOGIC ---
        let canvas;
        function initCanvas() {
            canvas = new fabric.Canvas('c');
            canvas.setBackgroundColor('#fff', canvas.renderAll.bind(canvas));
        }

        // Upload BG
        document.getElementById('bgInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function (event) {
                const imgObj = new Image();
                imgObj.src = event.target.result;
                imgObj.onload = function () {
                    const imgInstance = new fabric.Image(imgObj);
                    canvas.setBackgroundImage(imgInstance, canvas.renderAll.bind(canvas), {
                        scaleX: canvas.width / imgInstance.width,
                        scaleY: canvas.height / imgInstance.height
                    });
                }
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        // Upload Asset
        document.getElementById('assetInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function (event) {
                fabric.Image.fromURL(event.target.result, function(img) {
                    img.scaleToWidth(150);
                    canvas.add(img);
                });
            }
            reader.readAsDataURL(e.target.files[0]);
        });

        // Add Text (With ID support for Bulk)
        function addText(placeholder, fontSize, idName) {
            // Cek jika ID sudah ada (agar tidak duplikat untuk bulk item)
            if(idName) {
                const existing = canvas.getObjects().find(o => o.id === idName);
                if(existing) {
                    alert('Item ini sudah ada di kanvas. Silakan edit yang sudah ada.');
                    canvas.setActiveObject(existing);
                    return;
                }
            }

            const text = new fabric.IText(placeholder, {
                left: canvas.width / 2 - 100,
                top: canvas.height / 2,
                fontFamily: 'Helvetica',
                fontSize: fontSize || 20,
                fill: '#000000',
                id: idName // Property ID khusus
            });
            canvas.add(text);
            canvas.setActiveObject(text);
        }

        function deleteObject() {
            const active = canvas.getActiveObject();
            if (active) canvas.remove(active);
        }

        function downloadSingleImage() {
            const link = document.createElement('a');
            link.download = 'preview_sertifikat.png';
            link.href = canvas.toDataURL({ format: 'png', multiplier: 1 });
            link.click();
        }

        // --- 3. BULK GENERATE LOGIC ---
        
        // Helper: Parse Data dari Textarea
        function parseBulkData() {
            const raw = document.getElementById('bulkDataInput').value.trim();
            if(!raw) return [];
            
            // Split baris, lalu split koma
            return raw.split('\n').map(line => {
                const parts = line.split(',');
                if(parts.length < 2) return null;
                return {
                    name: parts[0].trim(),
                    number: parts[1].trim()
                };
            }).filter(item => item !== null);
        }

        async function generateBulkPDF() {
            const data = parseBulkData();
            if(data.length === 0) {
                alert('Data kosong atau format salah! Gunakan: Nama, Nomor (per baris)');
                return;
            }

            // Cari object di canvas
            const nameObj = canvas.getObjects().find(o => o.id === 'obj_name');
            const numObj = canvas.getObjects().find(o => o.id === 'obj_number');

            if(!nameObj && !numObj) {
                alert('Peringatan: Anda belum menambahkan elemen "Add Nama (Massal)" atau "Add Nomor (Massal)" ke dalam desain sertifikat.');
                return;
            }

            // UI Feedback
            const btn = document.querySelector('button[onclick="generateBulkPDF()"]');
            const indicator = document.getElementById('processingIndicator');
            btn.disabled = true;
            btn.innerText = "Sedang Memproses...";
            indicator.classList.remove('hidden');

            // Setup PDF (A4 Landscape: 297mm x 210mm)
            const pdf = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a4' });
            const width = pdf.internal.pageSize.getWidth();
            const height = pdf.internal.pageSize.getHeight();

            // Loop Data (Gunakan setTimeout agar browser tidak freeze)
            // Kita proses secara sync dalam async function
            try {
                for (let i = 0; i < data.length; i++) {
                    const item = data[i];
                    
                    // Update Canvas
                    if(nameObj) nameObj.set({ text: item.name });
                    if(numObj) numObj.set({ text: item.number });
                    
                    // Render ulang kanvas (Synchronous)
                    canvas.renderAll();

                    // Ambil gambar dari kanvas (JPEG lebih ringan daripada PNG untuk PDF)
                    const imgData = canvas.toDataURL('image/jpeg', 0.8);

                    // Tambahkan ke PDF
                    pdf.addImage(imgData, 'JPEG', 0, 0, width, height);

                    // Tambah halaman baru jika bukan item terakhir
                    if (i < data.length - 1) {
                        pdf.addPage();
                    }
                }

                // Simpan PDF
                pdf.save('Sertifikat_Massal.pdf');
                alert('Berhasil! File PDF telah didownload.');

            } catch (err) {
                console.error(err);
                alert('Terjadi kesalahan saat generate PDF.');
            } finally {
                // Reset UI
                btn.disabled = false;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg> Generate & Download PDF`;
                indicator.classList.add('hidden');
            }
        }

        // --- 4. EXCEL EXPORT LOGIC ---
        function downloadTemplateExcel() {
            const data = parseBulkData();
            if(data.length === 0) {
                alert('Data di kotak input masih kosong. Isi dulu untuk menyimpannya ke Excel.');
                return;
            }

            // Convert JSON ke Worksheet
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Data Sertifikat");

            // Download File
            XLSX.writeFile(workbook, "Data_Peserta.xlsx");
        }

        // --- 5. KWITANSI LOGIC ---
        function generateKwitansi() {
            document.getElementById('p_no').innerText = document.getElementById('k_no').value;
            document.getElementById('p_from').innerText = document.getElementById('k_from').value;
            document.getElementById('p_text_amount').innerText = document.getElementById('k_text_amount').value;
            document.getElementById('p_purpose').innerText = document.getElementById('k_purpose').value;
            let val = document.getElementById('k_amount').value;
            document.getElementById('p_amount').innerText = Number(val).toLocaleString('id-ID');
            document.getElementById('p_date').innerText = document.getElementById('k_date').value;
            document.getElementById('p_receiver').innerText = document.getElementById('k_receiver').value;
        }

        function printKwitansi() {
            const printContent = document.getElementById('kwitansiPreview').innerHTML;
            const original = document.body.innerHTML;
            document.body.innerHTML = printContent;
            window.print();
            document.body.innerHTML = original;
            location.reload(); 
        }
    </script>
</body>
</html>
